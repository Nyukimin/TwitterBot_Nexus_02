# 完了したタスクと今後の課題

## 完了したタスク
- `post_reply.py`において、`is_my_thread`が`False`の場合は返信を投稿しないようにロジックを修正しました。
- `gen_reply.py`において、`is_my_thread`が`False`の場合はAIによる返信を生成しないようにロジックを修正しました。
- `thread_checker.py`において、`reply_num`が0のリプライのみを処理対象とするフィルタリング機能を追加しました。
- `csv_generator.py`において、通知ページの再読み込みロジックを実装し、最新のリプライを取得できるように改善しました。
- `_extract_tweet_info` 関数の `reply_bot/fetch.py` への統合が完了しました。
- 重複するリプライIDをスキップするロジックが実装されました。
- 抽出結果を `extracted_tweets.csv` ファイルに追記するロジックが実装されました。
- `debug_page_source_NNN.html` (3桁の連番) の形式でHTMLソースを保存するよう変更されました。
- スクロール量が、ウィンドウの高さの80%分をスクロールすることで20%の重複を目指すように初期調整されました。

## 今後の課題
- スクロール量の適応的調整（1回のページリロード分の20%重複）の調査と実装が必要です。

# 現状の問題点

## 1. HTML解析セレクタの不正確さ
`reply_bot/fetch.py` 内のリプライ情報抽出セレクタが、Xの通知ページの実際のHTML構造と合致していないため、リプライ情報の抽出に失敗しています。これは、これまで参照していた `source.html` が、実際にSeleniumが取得するページソースと異なっていたことが一因です。

## 2. リプライが0件で取得される問題
上記のセレクタの不正確さにより、`fetch_replies` 関数がリプライを全く検出できていません。

## 3. `tweet_datetime` の日付比較エラー（解決済み）
`offset-naive` と `offset-aware` の `datetime` オブジェクトの比較エラーが発生していましたが、これは `reply_bot/fetch.py` の前回の修正で対応済みです。この修正が正しく機能するかを確認する必要があります。

# 現在の課題とルール

## 重要なルール
- **必ずconda環境を使用する**: すべてのPythonスクリプト実行時は `conda activate TwitterReplyEnv` を実行してから作業する
- **base環境での作業は禁止**: base環境では作業せず、必ずTwitterReplyEnv環境を使用する
- **絵文字の保持**: エージェントは絵文字を削除してはならない
- **ログファイルの配置**: すべてのログ関連ファイルは `/log` フォルダに配置し、Git追跡から除外する（.gitignoreに `/log` を追加）
- **デバッグ時のヘッドレスモード**: デバッグ中はヘッドレスモードを無効にしてブラウザを視覚的に確認できるようにする

## タイムアウト設定
- **ログインタイムアウト**: config.pyで `LOGIN_TIMEOUT_ENABLED` と `LOGIN_TIMEOUT_SECONDS` で制御可能
- **ページ読み込みタイムアウト**: `PAGE_LOAD_TIMEOUT_SECONDS` で設定可能
- **デフォルト値**: ログインタイムアウト60秒、ページ読み込みタイムアウト30秒

## 現在の課題
1. ログインタイムアウト内にログインが成功しない問題
2. 絵文字付きツイートの抽出で絵文字が消える問題（修正済み）
3. データベーススキーマの問題（修正済み）

## 解決済みの課題
- fetch.pyのsetup_driver関数未定義エラー（修正済み）
- スクロール回数の設定化（config.pyで制御可能）
- 0ページ目処理の追加
- 絵文字抽出ロジックの修正 