# Maya自動返信ボット仕様書（スレッド起点判定対応）

## 目的
本システムは、X（旧Twitter）上で「Maya（@Maya19960330）」アカウントに届いたリプライに対して、未返信のものへ自動的に返信を投稿することを目的とする。  
さらに、**リプライがスレッド形式（会話の途中）である場合、その起点となる元ツイートが自分（Maya）の投稿であるかどうかをたどって確認する機能**を持つ。

---

## 全体構成

### 1. リプライ収集
- 利用ライブラリ：`selenium` によるブラウザ自動操作（`snscrape` は使用しない）
- 操作対象：Twitterの通知ページ（https://twitter.com/notifications/mentions）
- 処理内容：
  - リプライ一覧を抽出
  - HTML構造から以下を取得：
    - リプライしたユーザーID
    - リプライ本文
    - リプライ元ツイートのURL、ツイートID
    - **そのリプライ元がさらにリプライである場合、順にたどる**
    - **スレッドの最初のツイート（起点）が自分の投稿かどうかを判定**

### 2. 起点ツイート判定ロジック
- 対象リプライが「リプライ to リプライ」であれば、`in_reply_to_status_id` をたどる
- 最終的にたどり着いた「起点ツイート」の投稿者が `@Maya19960330` かを確認
- 判定結果を元に、返信方針を以下のように分岐する：

| スレッド起点 | 返信方針 |
|--------------|----------|
| Mayaの投稿   | 通常どおり返信する（関与OK） |
| 他人の投稿   | 返信を控える、または内容を柔らかく調整する |

---

## 3. 未返信判定
- 利用：`replies.db`（SQLite）に記録された返信済みデータと照合
- 一致条件：ツイートIDがDBに存在しない場合 → 未返信とみなす

---

## 4. 自動返信文の生成
- 使用モジュール：`gen_reply.py`
- 返信のトーン：Mayaの人格（癒し・自然・少し色気）に基づく
- **起点が他人の場合は、あえて「敬語のみ」「丁寧だが薄めの反応」などに切り替えることも可能**

---

## 5. Seleniumによる投稿とCookie認証

- Cookieは `.pkl` ファイルで保存（初回は `get_cookie.py` にて手動ログイン後に取得）
- 投稿処理は `post_reply.py` にて行い、ログイン状態を維持したままツイートに返信

---

## データベース構成（replies.db）

| カラム名       | 内容                             |
|----------------|----------------------------------|
| tweet_id       | リプライ対象のツイートID（数値）   |
| user_id        | ユーザーIDまたはスクリーンネーム     |
| reply_text     | 返信した本文                       |
| is_my_thread   | boolean（True = 起点が自分）        |
| timestamp      | 投稿日時（ISOフォーマット）         |

---

## スケジュール実行
- 毎日1回またはN分ごとの実行を想定（`main.py`からバッチ起動可能）
- 実行後にログファイル（CSVまたはJSON）に処理履歴を保存

---

## フォルダ構成例

```
Twitter_reply/
├── reply_bot/
│   ├── main.py
│   ├── fetch.py（Selenium使用、スレッド判定含む）
│   ├── gen_reply.py
│   ├── post_reply.py
│   ├── get_cookie.py
│   ├── db.py
│   ├── config.py
│   ├── ...
├── cookie/
│   └── twitter_cookies_01.pkl
├── logs/
│   └── 返信ログや失敗記録など
└── requirements.txt
```

---

## 使用ライブラリ

- `selenium`
- `beautifulsoup4`
- `sqlite3`
- `openai`（任意）
